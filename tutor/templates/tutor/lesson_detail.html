{% extends 'tutor/base.html' %}

{% block title %}{{ lesson.title }} - {{ module.title }} - AstraLearn{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Lesson Header -->
    <div class="md:flex md:items-start md:justify-between mb-8">
        <div class="flex-1 min-w-0">
            <!-- Breadcrumb -->
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li>
                        <div class="flex items-center">
                            <a href="{% url 'tutor:course_list' %}" class="text-sm font-medium text-gray-500 hover:text-gray-700">
                                <i class="fas fa-home mr-2"></i> Home
                            </a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="flex-shrink-0 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            <a href="{% url 'tutor:course_detail' course.id %}" class="ml-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                                {{ course.title }}
                            </a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="flex-shrink-0 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            <span class="ml-2 text-sm font-medium text-gray-500">
                                {{ module.title }}
                            </span>
                        </div>
                    </li>
                </ol>
            </nav>

            <div class="mt-4 flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ lesson.title }}</h1>
                    <div class="mt-2 flex flex-wrap items-center text-sm text-gray-500">
                        <span class="flex items-center">
                            <i class="fas fa-folder-open text-indigo-500 mr-1.5"></i>
                            Module: {{ module.title }}
                        </span>
                        <span class="mx-2 text-gray-300">•</span>
                        <span class="flex items-center">
                            {% if progress.completed %}
                                <i class="fas fa-check-circle text-green-500 mr-1.5"></i>
                                <span class="text-green-600">Completed</span>
                            {% else %}
                                <i class="far fa-circle text-yellow-500 mr-1.5"></i>
                                <span class="text-yellow-600">In Progress</span>
                            {% endif %}
                        </span>
                        <span class="mx-2 text-gray-300">•</span>
                        <span class="flex items-center">
                            <i class="far fa-clock text-gray-400 mr-1.5"></i>
                            {{ lesson.duration }} min
                        </span>
                    </div>
                </div>
                
                {% if user.is_staff %}
                <div class="mt-4 sm:mt-0">
                    <a href="{% url 'admin:tutor_lesson_change' lesson.id %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-edit mr-2 -ml-1"></i> Edit Lesson
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="lg:grid lg:grid-cols-12 lg:gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-8">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
                <div class="px-4 py-5 sm:p-6">
                    <div class="prose max-w-none">
                        {{ lesson.content|safe }}
                    </div>

                    <!-- Lesson Resources -->
                    {% if lesson.resources.all %}
                    <div class="mt-10 border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Lesson Resources</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <ul class="divide-y divide-gray-200">
                                {% for resource in lesson.resources.all %}
                                <li class="py-3 flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-md bg-indigo-100 text-indigo-600">
                                            <i class="fas fa-file-{{ resource.file_type|default:'alt' }}"></i>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-900">{{ resource.title }}</p>
                                            <p class="text-sm text-gray-500">{{ resource.get_file_type_display }} • {{ resource.file.size|filesizeformat }}</p>
                                        </div>
                                    </div>
                                    <a href="{{ resource.file.url }}" class="ml-4 bg-white rounded-md text-sm font-medium text-indigo-600 hover:text-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Download
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Knowledge Check -->
                    {% if has_quiz %}
                    <div class="mt-10 border-t border-gray-200 pt-6">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="h-5 w-5 text-blue-400 fas fa-question-circle"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">Knowledge Check</h3>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <p>Test your understanding of this lesson with a short quiz.</p>
                                    </div>
                                    <div class="mt-4">
                                        <a href="{% url 'tutor:quiz_detail' lesson.quiz.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-question-circle mr-2 -ml-1"></i> Take Quiz
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Lesson Navigation -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div class="w-full sm:w-1/2 mb-4 sm:mb-0 sm:pr-2">
                            {% if prev_lesson %}
                            <a href="{% url 'tutor:lesson_detail' course.id prev_lesson.module.id prev_lesson.id %}" class="group w-full flex items-center justify-between px-6 py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span class="flex items-center">
                                    <i class="fas fa-arrow-left mr-2 text-gray-400 group-hover:text-gray-500"></i>
                                    Previous
                                </span>
                                <span class="text-xs text-gray-500 group-hover:text-gray-700">{{ prev_lesson.title|truncatechars:30 }}</span>
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="w-full sm:w-1/2 sm:pl-2">
                            {% if next_lesson %}
                            <a href="{% url 'tutor:lesson_detail' course.id next_lesson.module.id next_lesson.id %}" class="group w-full flex items-center justify-between px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span>Next</span>
                                <span class="flex items-center">
                                    <span class="text-xs text-indigo-100 group-hover:text-white mr-2">{{ next_lesson.title|truncatechars:30 }}</span>
                                    <i class="fas fa-arrow-right"></i>
                                </span>
                            </a>
                            {% elif has_quiz %}
                            <a href="{% url 'tutor:quiz_detail' lesson.quiz.id %}" class="group w-full flex items-center justify-between px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <span>Take Quiz</span>
                                <span class="flex items-center">
                                    <span class="text-xs text-blue-100 group-hover:text-white mr-2">Test your knowledge</span>
                                    <i class="fas fa-question-circle"></i>
                                </span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-4 mt-8 lg:mt-0">
            <!-- Completion Status -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Lesson Progress</h3>
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                {% if progress.completed %}
                                <i class="fas fa-check text-green-500 text-xl"></i>
                                {% else %}
                                <i class="fas fa-book text-indigo-500 text-xl"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <form method="post" action="{% url 'tutor:mark_lesson_complete' lesson.id %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="w-full flex items-center justify-between px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white {% if progress.completed %}bg-green-600 hover:bg-green-700 focus:ring-green-500{% else %}bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500{% endif %} focus:outline-none focus:ring-2 focus:ring-offset-2">
                                    <span>{% if progress.completed %}Completed{% else %}Mark as Complete{% endif %}</span>
                                    <i class="fas {% if progress.completed %}fa-check-circle{% else %}fa-check{% endif %} ml-2"></i>
                                </button>
                            </form>
                            <p class="mt-2 text-xs text-gray-500">
                                {% if progress.completed %}
                                    Completed on {{ progress.updated_at|date:"F j, Y" }}
                                {% else %}
                                    Mark this lesson as complete to track your progress
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Navigation -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Course Modules</h3>
                    <div class="flow-root">
                        <ul class="divide-y divide-gray-200">
                            {% for mod in course.modules.all %}
                            <li class="py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <span class="text-indigo-600 font-medium">{{ forloop.counter }}</span>
                                    </div>
                                    <div class="ml-4">
                                        <a href="{% url 'tutor:course_detail' course.id %}#module-{{ mod.id }}" class="text-sm font-medium text-gray-900 hover:text-indigo-600">{{ mod.title }}</a>
                                        <p class="text-sm text-gray-500">{{ mod.lessons.count }} lessons</p>
                                    </div>
                                    <div class="ml-auto">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if mod == module %}bg-indigo-100 text-indigo-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {% if mod == module %}Current{% else %}{{ mod.completed_lessons_count }}/{{ mod.lessons.count }}{% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% if mod == module %}
                                <div class="mt-3 ml-14">
                                    <ul class="space-y-2">
                                        {% for lsn in mod.lessons.all %}
                                        <li>
                                            <a href="{% url 'tutor:lesson_detail' course.id mod.id lsn.id %}" class="flex items-center text-sm {% if lsn == lesson %}text-indigo-600 font-medium{% else %}text-gray-600 hover:text-gray-900{% endif %}">
                                                <span class="flex-shrink-0 h-5 w-5 flex items-center justify-center">
                                                    {% if lsn.completed %}
                                                    <i class="fas fa-check-circle text-green-500"></i>
                                                    {% elif lsn == lesson %}
                                                    <i class="fas fa-arrow-right text-indigo-500"></i>
                                                    {% else %}
                                                    <i class="far fa-circle text-gray-300"></i>
                                                    {% endif %}
                                                </span>
                                                <span class="ml-2 truncate">{{ lsn.title }}</span>
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant Button (floating) -->
<button id="ai-assistant-button" class="fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-110" aria-label="AI Assistant">
    <i class="fas fa-robot text-2xl"></i>
</button>

<!-- AI Assistant Panel (initially hidden) -->
<div id="ai-assistant-panel" class="fixed bottom-24 right-6 w-96 bg-white rounded-lg shadow-xl overflow-hidden transform translate-y-4 opacity-0 invisible transition-all duration-300 ease-in-out z-50">
    <div class="bg-indigo-600 px-4 py-3 flex items-center justify-between">
        <h3 class="text-white font-medium">AI Learning Assistant</h3>
        <button id="close-ai-panel" class="text-indigo-200 hover:text-white focus:outline-none">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="p-4 h-96 overflow-y-auto">
        <div class="bg-indigo-50 rounded-lg p-4 mb-4">
            <p class="text-sm text-indigo-700">Hello! I'm your AI learning assistant. How can I help you with this lesson?</p>
        </div>
        <div id="ai-messages" class="space-y-4">
            <!-- AI messages will be inserted here -->
        </div>
    </div>
    <div class="border-t border-gray-200 p-4">
        <div class="flex">
            <input type="text" id="ai-message-input" placeholder="Ask me anything..." class="flex-1 min-w-0 block w-full px-3 py-2 rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <button id="send-ai-message" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <p class="mt-2 text-xs text-gray-500">Ask questions about the lesson content or request explanations.</p>
    </div>
</div>

<!-- Overlay (hidden by default) -->
<div id="ai-assistant-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 invisible transition-opacity duration-300"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize code syntax highlighting
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });

        // AI Assistant Panel Toggle
        const aiButton = document.getElementById('ai-assistant-button');
        const aiPanel = document.getElementById('ai-assistant-panel');
        const aiOverlay = document.getElementById('ai-assistant-overlay');
        const closeButton = document.getElementById('close-ai-panel');
        const aiMessageInput = document.getElementById('ai-message-input');
        const sendMessageButton = document.getElementById('send-ai-message');
        const aiMessages = document.getElementById('ai-messages');
        
        let isPanelOpen = false;

        function toggleAIPanel() {
            isPanelOpen = !isPanelOpen;
            
            if (isPanelOpen) {
                aiPanel.classList.remove('translate-y-4', 'opacity-0', 'invisible');
                aiPanel.classList.add('translate-y-0', 'opacity-100', 'visible');
                aiOverlay.classList.remove('opacity-0', 'invisible');
                aiOverlay.classList.add('opacity-100', 'visible');
                aiMessageInput.focus();
            } else {
                aiPanel.classList.add('translate-y-4', 'opacity-0', 'invisible');
                aiPanel.classList.remove('translate-y-0', 'opacity-100', 'visible');
                aiOverlay.classList.add('opacity-0', 'invisible');
                aiOverlay.classList.remove('opacity-100', 'visible');
            }
        }

        function sendAIMessage() {
            const message = aiMessageInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            aiMessageInput.value = '';

            // Simulate AI response (in a real app, this would be an API call)
            setTimeout(() => {
                const responses = [
                    "I can help explain that concept. The key point is...",
                    "That's a great question! Here's what you need to know...",
                    "Let me break that down for you...",
                    "Based on this lesson, the answer is..."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage('ai', randomResponse);
            }, 1000);
        }

        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                sender === 'user' 
                    ? 'bg-indigo-600 text-white rounded-br-none' 
                    : 'bg-gray-100 text-gray-800 rounded-bl-none'
            }`;
            bubble.textContent = text;
            
            messageDiv.appendChild(bubble);
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // Event Listeners
        aiButton.addEventListener('click', toggleAIPanel);
        closeButton.addEventListener('click', toggleAIPanel);
        aiOverlay.addEventListener('click', toggleAIPanel);
        
        sendMessageButton.addEventListener('click', sendAIMessage);
        
        aiMessageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
    });
</script>
{% endblock %}
